<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Compare Viewsheds</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body,#map { height: 100%; margin: 0; padding: 0; }
    .legend { background: white; padding: 6px; border-radius: 4px; box-shadow: 0 0 6px rgba(0,0,0,0.2); }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map('map');
    const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    const topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenTopoMap'
    });

    // GeoJSON file paths (generated by the script)
    const files = [
      { url: 'data/viewshed_obsA.geojson', color: '#00cc00', name: 'Observer A', markerColor: 'red' },
      { url: 'data/viewshed_obsB.geojson', color: '#0066ff', name: 'Observer B', markerColor: 'orange' }
    ];

    const layers = [];
    const observerMarkers = [];

    Promise.all(files.map(f => fetch(f.url).then(r => r.json()).catch(e => { console.error('load err', f.url, e); return null; })))
      .then(jsons => {
        jsons.forEach((data, idx) => {
          if (!data) return;
          const f = files[idx];
          const polygon = L.geoJSON(data, {
            style: { color: f.color, fillColor: f.color, fillOpacity: 0.35, weight: 1 }
          }).addTo(map);
          layers.push({ name: f.name, layer: polygon });

          // compute centroid for a marker (use bounds center)
          const bounds = polygon.getBounds();
          if (bounds.isValid()) {
            const center = bounds.getCenter();
            const marker = L.circleMarker(center, { radius: 6, color: f.markerColor, fillColor: f.markerColor, fillOpacity: 0.9 })
              .bindPopup(`<b>${f.name}</b><br/>Center: ${center.lat.toFixed(6)}, ${center.lng.toFixed(6)}`)
              .addTo(map);
            observerMarkers.push(marker);
          }
        });

        // Fit map to combined bounds of all visible layers
        const group = L.featureGroup(layers.map(o => o.layer));
        if (group.getBounds().isValid()) {
          map.fitBounds(group.getBounds().pad(0.2));
        } else {
          map.setView([34.2, 71.4], 12);
        }

        // Layer control
        const baseMaps = { "OSM": osm, "Topo": topo };
        const overlayMaps = {};
        layers.forEach(o => overlayMaps[o.name] = o.layer);
        observerMarkers.forEach((m, i) => overlayMaps[`Observer marker ${i+1}`] = m);
        L.control.layers(baseMaps, overlayMaps, { collapsed: false }).addTo(map);

        // Small legend
        const legend = L.control({position: 'topright'});
        legend.onAdd = function() {
          const div = L.DomUtil.create('div','legend');
          div.innerHTML = '<b>Viewsheds</b><br/><div style="display:flex;gap:8px;align-items:center;margin-top:6px">'
            + `<div style="width:18px;height:12px;background:${files[0].color};opacity:0.8"></div> ${files[0].name}<br/>`
            + `<div style="width:18px;height:12px;background:${files[1].color};opacity:0.8"></div> ${files[1].name}`
            + '</div>';
          return div;
        };
        legend.addTo(map);

      })
      .catch(err => console.error('Error loading geojson files', err));
  </script>
</body>
</html>
